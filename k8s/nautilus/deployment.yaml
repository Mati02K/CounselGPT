apiVersion: apps/v1
kind: Deployment
metadata:
  name: counselgpt-api-mthiruma
  namespace: cse239fall2025

spec:
  replicas: 2

  selector:
    matchLabels:
      app: counselgpt-api-mthiruma

  template:
    metadata:
      labels:
        app: counselgpt-api-mthiruma

    spec:

      tolerations:
      - key: "nvidia.com/gpu"
        operator: "Exists"
        effect: "NoSchedule"

      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:

              # 1. Force L40 GPU
              - key: nvidia.com/gpu.product
                operator: In
                values:
                - NVIDIA-L40

              # 2. CUDA version: require CUDA 12.4+
              - key: nvidia.com/cuda.runtime.major
                operator: In
                values:
                - "12"
              - key: nvidia.com/cuda.runtime.minor
                operator: Gt
                values:
                - "3"

      containers:
      - name: counselgpt-api
        image: mathesh0208/counselgptapi:v11

        ports:
        - containerPort: 8000

        resources:
          limits:
            cpu: "2"
            memory: "8Gi"
            nvidia.com/gpu: "1"
          requests:
            cpu: "1"
            memory: "4Gi"
            nvidia.com/gpu: "1"

        env:
        - name: QWEN_MODEL_PATH
          value: "/models/qwen/Qwen2.5-7B-Instruct-Q8_0.gguf"
        - name: QWEN_LORA_PATH
          value: "/models/qwen/legal_lora_adapter_only_25k.gguf"
        - name: QWEN_GPU_LAYERS
          value: "-1"
        - name: LLAMA_MODEL_PATH
          value: "/models/llama/llama-2-7b-chat.Q4_K_M.gguf"
        - name: LLAMA_GPU_LAYERS
          value: "-1"
        - name: LLM_N_THREADS
          value: "8"
        - name: REDIS_URL
          value: "redis://counselgpt-redis-mthiruma:6379"

        volumeMounts:
        - name: model-volume
          mountPath: /models

        startupProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 30

        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

      volumes:
      - name: model-volume
        persistentVolumeClaim:
          claimName: counselgpt-models-pvc-mthiruma
