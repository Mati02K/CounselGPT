apiVersion: batch/v1
kind: Job
metadata:
  name: s3-sync-mthiruma
  namespace: cse239fall2025
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: s3-sync
        image: ubuntu:22.04
        resources:
          requests:
            cpu: "50m"
            memory: "256Mi"
          limits:
            cpu: "200m"
            memory: "512Mi"
        command: ["/bin/bash", "-c"]
        args:
        - |
          apt-get update && apt-get install -y s3cmd ca-certificates curl

          echo "[default]" > /root/.s3cfg
          echo "access_key = ${S3_ACCESS_KEY}" >> /root/.s3cfg
          echo "secret_key = ${S3_SECRET_KEY}" >> /root/.s3cfg
          echo "host_base = https://s3-west.nrp-nautilus.io" >> /root/.s3cfg
          echo "host_bucket = https://s3-west.nrp-nautilus.io" >> /root/.s3cfg
          echo "use_https = True" >> /root/.s3cfg
          echo "signature_v2 = False" >> /root/.s3cfg

          echo "[SYNC] Creating model directories..."
          mkdir -p /models/llama
          mkdir -p /models/qwen

          echo "[SYNC] Downloading LLaMA model..."
          s3cmd get s3://counselgpt-models/llama-2-7b-chat.Q4_K_M.gguf \
            /models/llama/llama-2-7b-chat.Q4_K_M.gguf --force

          echo "[SYNC] Downloading Qwen base..."
          s3cmd get s3://counselgpt-models/Qwen2.5-7B-Instruct-Q8_0.gguf \
            /models/qwen/Qwen2.5-7B-Instruct-Q8_0.gguf --force

          echo "[SYNC] Downloading Qwen LoRA adapter..."
          s3cmd get s3://counselgpt-models/legal_lora_adapter_only_25k.gguf \
            /models/qwen/legal_lora_adapter_only_25k.gguf --force

          echo "[SYNC COMPLETE] Models in /models:"
          ls -lhR /models

        env:
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: ceph-s3-credentials
              key: S3_ACCESS_KEY
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: ceph-s3-credentials
              key: S3_SECRET_KEY

        volumeMounts:
        - name: model-volume
          mountPath: /models

      volumes:
      - name: model-volume
        persistentVolumeClaim:
          claimName: counselgpt-models-pvc-mthiruma
